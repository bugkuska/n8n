{
  "name": "06-AI Agent_Gemini_simple_Line_Docs",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai_writer",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1568,
        400
      ],
      "id": "8d85bf6a-d02d-4e7d-8cf8-bf99d770fd1a",
      "name": "Webhook-AI-Writer",
      "webhookId": "0ca84b98-9ddd-4695-a8d8-5facf4039b21"
    },
    {
      "parameters": {
        "functionCode": "// event ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å LINE Webhook\nconst e = $json.body?.events?.[0];\n\n// ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ event\nif (!e) {\n  return [{ json: { error: 'No LINE event found' } }];\n}\n\n// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ message event\nif (e.type !== 'message' || e.message?.type !== 'text') {\n  return [\n    {\n      json: {\n        skip: true,\n        reason: 'Not a text message event',\n        eventType: e.type\n      }\n    }\n  ];\n}\n\n// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°\nconst text = e.message.text.trim();\n\n// normalize ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI / fuzzy\nconst key = text.toLowerCase();\n\n// source id\nconst userId = e.source?.userId || null;\nconst groupId = e.source?.groupId || null;\nconst roomId = e.source?.roomId || null;\n\n// chatId ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô target ‡∏´‡∏•‡∏±‡∏Å\nconst chatId = userId || groupId || roomId;\n\n// replyToken (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)\nconst replyToken = e.replyToken || null;\n\n// ‡∏ä‡∏ô‡∏¥‡∏î‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤\nconst sourceType = e.source?.type || null;\n\n// timestamp\nconst ts = new Date().toISOString();\n\nreturn [\n  {\n    json: {\n      text,\n      key,\n      chatId,\n      replyToken,\n      sourceType,\n      userId,\n      groupId,\n      roomId,\n      ts\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1392,
        400
      ],
      "name": "Code | Extract LINE Event",
      "id": "103aa4bb-6a65-4691-9c74-95908d2b3e1f",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "message": "={{$json.message}}",
        "replyToken": "=",
        "targetRecipient": "={{$node[\"Set (LINE Target)\"].json.toId}}"
      },
      "type": "n8n-nodes-linewebhook.LineMessaging",
      "typeVersion": 1,
      "position": [
        -336,
        672
      ],
      "id": "aceb1dc8-79aa-461c-ac06-3c66babdb619",
      "name": "LineMessaging-SendMessage",
      "credentials": {
        "lineMessagingAuthApi": {
          "id": "wXnrVemS4WUGnS35",
          "name": "Line Messaging Auth account-n8n-depa01-ai_writer"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentURL": "1IbeXlGFDC-tT8skVAzqiCFvQ2LViA-Y13-QZOWzEwvk",
        "actionsUi": {
          "actionFields": [
            {
              "action": "insert",
              "text": "={{ $json.block + \"\\n\\n\" }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.googleDocs",
      "typeVersion": 2,
      "position": [
        -688,
        464
      ],
      "id": "cb95d677-4510-46ea-849a-38bc31bd8ef9",
      "name": "Google Docs | Append",
      "credentials": {
        "googleApi": {
          "id": "PtP6aVOeFantVH0Y",
          "name": "Google Docs account-n8n-depa001-ai_writer"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "b17bdfc3-544b-416a-934d-b85e7c59777d",
              "leftValue": "={{ $json.skip === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1200,
        400
      ],
      "id": "e99c479d-8a0a-4add-b156-22c1f704105f",
      "name": "IF | Skip?"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Code node: Code | Build LINE Reply (FIX - works in Code node v2)\n\n// 1) LINE event (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å node Extract)\nconst ev = $node[\"Code | Extract LINE Event\"].json ?? {};\nconst userText = String(ev.text ?? \"\").trim();\nconst replyToken = ev.replyToken ?? null;\nconst ts = ev.ts ?? new Date().toISOString();\n\n// 2) AI answer (‡∏à‡∏≤‡∏Å Gemini simplified output)\nconst aiAnswer = String($json.content?.parts?.[0]?.text ?? \"\").trim()\n  || \"‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ\";\n\n// 3) Google Docs block\nconst block =\n`üïí ${ts}\nüìù ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${userText}\n\nü§ñ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:\n${aiAnswer}\n----------------------------------------`;\n\n// 4) LINE message\nconst lineText =\n`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Docs ‡πÅ‡∏•‡πâ‡∏ß\nüìù ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${userText}\n\nü§ñ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:\n${aiAnswer}`;\n\n// ‚úÖ Code node v2: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô object ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ array)\nreturn {\n  replyToken,\n  userText,\n  aiAnswer,\n  block,\n  lineText,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        464
      ],
      "id": "6e3e3d35-1227-466e-8550-72a787059a7c",
      "name": "Code | Build LINE Reply"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "=‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏™‡∏∏‡∏†‡∏≤‡∏û\n‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n1) ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö 1-2 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)\n2) ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ bullet 5-10 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î\n3) ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ \"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Docs ‡πÅ‡∏•‡πâ‡∏ß\"\n4) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤\n\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:\n{{$json.text}}"
            },
            {}
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        -1216,
        656
      ],
      "id": "20b1b195-6a15-4da4-a656-68b76e6f1b04",
      "name": "Message a model1",
      "credentials": {
        "googlePalmApi": {
          "id": "UN1k5CmPibFsJDfw",
          "name": "Google Gemini(PaLM-n8n-depa-ai_writer01"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "toId",
              "value": "={{ $node[\"Code | Extract LINE Event\"].json.chatId }}"
            },
            {
              "name": "message",
              "value": "={{ $json.lineText }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set (LINE Target)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -752,
        672
      ],
      "id": "f6a64877-21dd-4d95-87da-672bfdbb4093",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "text": "={{$json.message}}"
      },
      "type": "n8n-nodes-linewebhook.LineMessageNode",
      "typeVersion": 1,
      "position": [
        -560,
        672
      ],
      "id": "982fdec6-c293-4afc-b1e4-0f02ec2348c1",
      "name": "LineMessageNode"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook-AI-Writer": {
      "main": [
        [
          {
            "node": "Code | Extract LINE Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code | Extract LINE Event": {
      "main": [
        [
          {
            "node": "IF | Skip?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF | Skip?": {
      "main": [
        [],
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code | Build LINE Reply": {
      "main": [
        [
          {
            "node": "Google Docs | Append",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set (LINE Target)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Code | Build LINE Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set (LINE Target)": {
      "main": [
        [
          {
            "node": "LineMessageNode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LineMessageNode": {
      "main": [
        [
          {
            "node": "LineMessaging-SendMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "ce9778c1-dc3b-4623-af5a-9ac4932f134a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6e8bd4e6dcfe2d257f6d9648f4efaf76882daef04e1402d554d9aae9132bba97"
  },
  "id": "6XuCJZLtGgCo6DnBhS4yS",
  "tags": []
}
